//~ Revision: 117, Copyright (C) 2016-2018: Willem Vree, contributions St√©phane David.
//~ This program is free software; you can redistribute it and/or modify it under the terms of the
//~ GNU General Public License as published by the Free Software Foundation; either version 2 of
//~ the License, or (at your option) any later version.
//~ This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
//~ without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
//~ See the GNU General Public License for more details. <http://www.gnu.org/licenses/gpl.html>.
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.arrayIteratorImpl=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}};$jscomp.arrayIterator=function(a){return{next:$jscomp.arrayIteratorImpl(a)}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,l){a!=Array.prototype&&a!=Object.prototype&&(a[b]=l.value)};$jscomp.getGlobal=function(a){a=["object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global,a];for(var b=0;b<a.length;++b){var l=a[b];if(l&&l.Math==Math)return l}return globalThis};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.SymbolClass=function(a,b){this.$jscomp$symbol$id_=a;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:b})};$jscomp.SymbolClass.prototype.toString=function(){return this.$jscomp$symbol$id_};
$jscomp.Symbol=function(){function a(l){if(this instanceof a)throw new TypeError("Symbol is not a constructor");return new $jscomp.SymbolClass($jscomp.SYMBOL_PREFIX+(l||"")+"_"+b++,l)}var b=0;return a}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("Symbol.iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}});$jscomp.initSymbolIterator=function(){}};
$jscomp.initSymbolAsyncIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.asyncIterator;a||(a=$jscomp.global.Symbol.asyncIterator=$jscomp.global.Symbol("Symbol.asyncIterator"));$jscomp.initSymbolAsyncIterator=function(){}};$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};
$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var l=0,r={next:function(){if(l<a.length){var d=l++;return{value:b(d,a[d]),done:!1}}r.next=function(){return{done:!0,value:void 0}};return r.next()}};r[Symbol.iterator]=function(){return r};return r};
$jscomp.polyfill=function(a,b,l,r){if(b){l=$jscomp.global;a=a.split(".");for(r=0;r<a.length-1;r++){var d=a[r];d in l||(l[d]={});l=l[d]}a=a[a.length-1];r=l[a];b=b(r);b!=r&&null!=b&&$jscomp.defineProperty(l,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");$jscomp.polyfill("Math.log10",function(a){return a?a:function(a){return Math.log(a)/Math.LN10}},"es6","es3");
$jscomp.makeIterator=function(a){var b="undefined"!=typeof Symbol&&Symbol.iterator&&a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(a){function b(){this.batch_=null}function l(a){return a instanceof d?a:new d(function(t,b){t(a)})}if(a&&!$jscomp.FORCE_POLYFILL_PROMISE)return a;b.prototype.asyncExecute=function(a){if(null==this.batch_){this.batch_=[];var t=this;this.asyncExecuteFunction(function(){t.executeBatch_()})}this.batch_.push(a)};var r=$jscomp.global.setTimeout;b.prototype.asyncExecuteFunction=function(a){r(a,0)};b.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var a=
this.batch_;this.batch_=[];for(var C=0;C<a.length;++C){var b=a[C];a[C]=null;try{b()}catch(S){this.asyncThrow_(S)}}}this.batch_=null};b.prototype.asyncThrow_=function(a){this.asyncExecuteFunction(function(){throw a;})};var d=function(a){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var t=this.createResolveAndReject_();try{a(t.resolve,t.reject)}catch(R){t.reject(R)}};d.prototype.createResolveAndReject_=function(){function a(a){return function(t){d||(d=!0,a.call(b,t))}}var b=this,d=!1;
return{resolve:a(this.resolveTo_),reject:a(this.reject_)}};d.prototype.resolveTo_=function(a){if(a===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(a instanceof d)this.settleSameAsPromise_(a);else{a:switch(typeof a){case "object":var t=null!=a;break a;case "function":t=!0;break a;default:t=!1}t?this.resolveToNonPromiseObj_(a):this.fulfill_(a)}};d.prototype.resolveToNonPromiseObj_=function(a){var t=void 0;try{t=a.then}catch(R){this.reject_(R);return}"function"==typeof t?
this.settleSameAsThenable_(t,a):this.fulfill_(a)};d.prototype.reject_=function(a){this.settle_(2,a)};d.prototype.fulfill_=function(a){this.settle_(1,a)};d.prototype.settle_=function(a,b){if(0!=this.state_)throw Error("Cannot settle("+a+", "+b+"): Promise already settled in state"+this.state_);this.state_=a;this.result_=b;this.executeOnSettledCallbacks_()};d.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var a=0;a<this.onSettledCallbacks_.length;++a)X.asyncExecute(this.onSettledCallbacks_[a]);
this.onSettledCallbacks_=null}};var X=new b;d.prototype.settleSameAsPromise_=function(a){var b=this.createResolveAndReject_();a.callWhenSettled_(b.resolve,b.reject)};d.prototype.settleSameAsThenable_=function(a,b){var d=this.createResolveAndReject_();try{a.call(b,d.resolve,d.reject)}catch(S){d.reject(S)}};d.prototype.then=function(a,b){function t(a,b){return"function"==typeof a?function(b){try{l(a(b))}catch(Y){r(Y)}}:b}var l,r,C=new d(function(a,b){l=a;r=b});this.callWhenSettled_(t(a,l),t(b,r));return C};
d.prototype.catch=function(a){return this.then(void 0,a)};d.prototype.callWhenSettled_=function(a,b){function d(){switch(l.state_){case 1:a(l.result_);break;case 2:b(l.result_);break;default:throw Error("Unexpected state: "+l.state_);}}var l=this;null==this.onSettledCallbacks_?X.asyncExecute(d):this.onSettledCallbacks_.push(d)};d.resolve=l;d.reject=function(a){return new d(function(b,d){d(a)})};d.race=function(a){return new d(function(b,d){for(var t=$jscomp.makeIterator(a),r=t.next();!r.done;r=t.next())l(r.value).callWhenSettled_(b,
d)})};d.all=function(a){var b=$jscomp.makeIterator(a),r=b.next();return r.done?l([]):new d(function(a,d){function t(b){return function(d){C[b]=d;G--;0==G&&a(C)}}var C=[],G=0;do C.push(void 0),G++,l(r.value).callWhenSettled_(t(C.length-1),d),r=b.next();while(!r.done)})};return d},"es6","es3");var xmlplay_VERSION=117;
(function(){function a(c){H.innerHTML+=c+"\n"}function b(c){a(c);A.innerHTML+=c+"<br>"}function l(c){a(c);A.innerHTML+='<div style="white-space: nowrap">'+c+"</div>"}function r(c){var k=c.slice(0,4E3);0<=k.indexOf("X:")?C(c):-1==k.indexOf("<?xml ")?alert("not an xml file nor an abc file"):(c=(new window.DOMParser).parseFromString(c,"text/xml"),k={p:"f",t:1,u:0,v:3,m:2,mnum:0},Ja&&(k.p=""),Ka&&(k.x=1),c=vertaal(c,k),c[1]&&a(c[1]),C(c[0]))}function d(){var c,a=new FileReader;a.onload=function(c){r(a.result)};
if(c=pa?pa[0]:aa.files[0])qa=c.name.split(".")[0],a.readAsText(c)}function X(c){H.innerHTML="";var k=c[0].link;qa=c[0].name.split(".")[0];A.style.display="block";a("link: "+k+"<br>");var f=new XMLHttpRequest;f.open("GET",k,!0);f.onload=function(){a("XHR ok");A.style.display="none";r(f.responseText)};f.onerror=function(){b("XHR failed")};f.send()}function t(a){a.stopPropagation();a.preventDefault();pa=a.dataTransfer.files;this.classList.remove("indrag");d()}function C(a){function c(a){var c,g,e,f,
k,m={},n={},b=[18,20,22,24,26,28];a=a.split("\n");for(c=0;c<a.length;++c){var d=a[c];if(0<=d.indexOf("strings")&&(g=d.match(/V:\s*(\S+).*strings\s*=\s*(\S+)/))){var l=g[1];m[l]={};g[2].split(",").forEach(function(a,c){e=a[0];f=12*parseInt(a[1]);k=f+[0,2,4,5,7,9,11]["CDEFGAB".indexOf(e)]+12;m[l][b[c]]=k});n[l]=0<=d.indexOf("diafret")}}return[m,n]}function f(a){var c,g,e={};a=a.split("\n");for(c=0;c<a.length;++c){var f=a[c];if(0<=f.indexOf("%%map")&&(g=f.match(/%%map *(\S+) *(\S+).*midi=(\d+)/))){f=
g[1];var k=g[2];g=g[3];e[f+k]=parseInt(g)}}return e}function e(a){var c={diamond:1,triangle:1,square:1,normal:1},g=n,e,f="default",k={"default":[]},m={"default":[]};a=a.split("\n");for(e=0;e<a.length;++e){var b=a[e];if(0<=b.indexOf("I:percmap")){b=b.split(" ").map(function(a){return a.trim()});var d=b[4];d in c&&(d=d+"+,"+d);b="%%map perc"+f+" "+b[1]+" print="+b[2]+" midi="+b[3]+" heads="+d;k[f].push(b)}0<=b.indexOf("%%MIDI")&&m[f].push(b);0<=b.indexOf("V:")&&(d=b.match(/V:\s*(\S+)/))&&(f=d[1],f in
k||(k[f]=[],m[f]=[]))}c=Object.keys(k).sort();for(e=0;e<c.length;++e)g=g.concat(k[c[e]]);f="default";for(e=0;e<a.length;++e)b=a[e],0<=b.indexOf("I:percmap")||0<=b.indexOf("%%MIDI")||(0<=b.indexOf("V:")||0<=b.indexOf("K:")?((d=b.match(/V:\s*(\S+)/))&&(f=d[1]),g.push(b),f in m&&m[f].length&&(g=g.concat(m[f]),delete m[f]),0<=b.indexOf("perc")&&-1==b.indexOf("map=")&&(b+=" map=perc"),0<=b.indexOf("map=perc")&&0<k[f].length&&g.push("%%voicemap perc"+f),0<=b.indexOf("map=off")&&g.push("%%voicemap")):g.push(b));
return g.join("\n")}var n='%%beginsvg\n<defs>,<text id="x" x="-3" y="0">&#xe263;</text>,<text id="x-" x="-3" y="0">&#xe263;</text>,<text id="x+" x="-3" y="0">&#xe263;</text>,<text id="normal" x="-3.7" y="0">&#xe0a3;</text>,<text id="normal-" x="-3.7" y="0">&#xe0a3;</text>,<text id="normal+" x="-3.7" y="0">&#xe0a4;</text>,<g id="circle-x"><text x="-3" y="0">&#xe263;</text><circle r="4" class="stroke"></circle></g>,<g id="circle-x-"><text x="-3" y="0">&#xe263;</text><circle r="4" class="stroke"></circle></g>,<path id="triangle" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="stroke-width:1.4"></path>,<path id="triangle-" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="stroke-width:1.4"></path>,<path id="triangle+" d="m-4 -3.2l4 6.4 4 -6.4z" class="stroke" style="fill:#000"></path>,<path id="square" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="stroke-width:1.4"></path>,<path id="square-" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="stroke-width:1.4"></path>,<path id="square+" d="m-3.5 3l0 -6.2 7.2 0 0 6.2z" class="stroke" style="fill:#000"></path>,<path id="diamond" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="stroke-width:1.4"></path>,<path id="diamond-" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="stroke-width:1.4"></path>,<path id="diamond+" d="m0 -3l4.2 3.2 -4.2 3.2 -4.2 -3.2z" class="stroke" style="fill:#000"></path>,</defs>\n%%endsvg'.split(",");
0<=a.indexOf("I:percmap")&&(a=e(a));0<=a.indexOf("%%map")&&(La=f(a));0<=a.indexOf(" strings")&&c(a);ra=a;R(a);S(a)}function R(c){function k(a){var c=[];a.forEach(function(a,e){c[a.st]?c[a.st].push(e):c[a.st]=[e];a.clef.clef_octave&&(ba[e]=a.clef.clef_octave);Ma[a.st]=6*(a.stafflines||"|||||").length*(a.staffscale||1);J[e]=a.midictl&&a.midictl[7];void 0==J[e]&&(J[e]=100);K[e]=a.midictl&&a.midictl[10];void 0==K[e]&&(K[e]=64);g[e]=a.instr?a.instr:0});return c}var f="",e=[3,0,4,1,5,2,6],b=[0,2,4,5,7,
9,11];O=[];ba=[];L.value=x.speed;P=120;J=[];K=[];var g=[];var B=new Abc({img_out:null,errmsg:function(a,c,e){f+=a+"\n"},read_file:function(a){return""},anno_start:null,get_abcmodel:function(a,f,n){function B(a,c){m[a]=[0,0,0,0,0,0,0];p[a]={};D[a]=c;var f=0<=c;(f?e.slice(0,c):e.slice(c)).forEach(function(c){m[a][c]+=f?1:-1})}var m={},d={"-2":-2,"-1":-1,0:0,1:1,2:2,3:0},p={},D={},E={},l={ppp:30,pp:45,p:60,mp:75,mf:90,f:105,ff:120,fff:127},r=[];n=f[0].meter.a_meter;n.length&&parseInt(n[0].top);for(q=
0;q<f.length;++q)B(q,f[q].key.k_sf),E[q]={};n={};Na=f.length;sa=k(f);for(var h=a;h;h=h.ts_next){var t=[],q;switch(h.type){case 14:(a=h.tempo_notes)?(a=h.tempo_notes.reduce(function(a,c){return a+c}),P=h.tempo*a/384):(a=c.slice(h.istart,h.iend),(a=a.match(/\d+/))&&(P=1*a[0]));break;case 10:var z={t:h.time,mnum:-1,dur:h.dur};t.push(z);O.push({t:h.time,ix:h.istart,v:h.v,ns:t,inv:h.invis,tmp:P});break;case 8:var x=g[h.v];"p"==h.p_v.clef.clef_type&&(x+=128);for(a=0;a<h.notes.length;++a){f=h.notes[a];var v=
f.pit+19;q=h.v;h.a_dd&&h.a_dd.forEach(function(a){(u=l[a.name])&&sa[h.st].forEach(function(a){r[a]=u});"swing"==a.name&&(a=h.dur/3,h.dur+=a,h.next.time+=a,h.next.dur-=a)});var u=r[q]||60;ba[q]&&(v+=ba[q]);z=Math.floor(v/7);var w=v%7;void 0!=f.acc&&(p[q][v]=d[f.acc]);z=12*z+b[w]+(v in p[q]?p[q][v]:m[q][w]);w=h.p_v.map;f.midi&&(z=f.midi);if(128<=x&&"MIDIdrum"!=w){var A=c.substring(h.istart,h.iend);A=A.match(/[=_^]*[A-Ga-g]/)[0];(w=La[w+A])&&(z=w)}z=128*x+z;n[z]=1;z={t:h.time,mnum:z,dur:h.dur,velo:u};
v in E[q]?(E[q][v].dur+=h.dur,f.tie_ty||delete E[q][v],z.mnum=-1):f.tie_ty&&(E[q][v]=z);t.push(z)}if(0==t.length)break;O.push({t:h.time,ix:h.istart,v:h.v,ns:t,stf:h.st,tmp:P});break;case 5:B(h.v,h.k_sf);break;case 0:B(h.v,D[h.v]);O.push({t:h.time,ix:h.istart,v:h.v,bt:h.bar_type,tx:h.text});break;case 16:h.instr&&(g[h.v]=h.instr),7==h.ctrl&&(J[h.v]=h.val),10==h.ctrl&&(K[h.v]=h.val)}}ta.forEach(function(a){var c=a.parentNode;c&&c.removeChild(a)});ca=[];d="#f9f #3cf #c99 #f66 #fc0 #cc0 #ccc".split(" ");
for(a=0;a<Na;++a)E=1<<a&ua?"0":"",q=document.createElementNS("http://www.w3.org/2000/svg","rect"),q.setAttribute("fill",d[a%d.length]+E),q.setAttribute("fill-opacity","0.5"),q.setAttribute("width","0"),ta.push(q),ca.push(-1);va=Object.keys(n);null!=y?da():alert("Your browser has no Web Audio API -> no playback.")}});B.tosvg("play","%%play");B.tosvg("abc2svg",c);""==f&&(f="no error");a(f.trim())}function S(c){function k(a){a.stopPropagation();var c=a.clientX;c-=this.getBoundingClientRect().left;var e=
c*ea;if(e<p+24||e>E)T();else{var f=M.indexOf(this);var g=(a.clientY-this.getBoundingClientRect().top)*ea;c=fa[f];for(a=0;a<c.length;a++)if(c[a]>g){ha=a;Z(f);break}for(a=0;a<v.length;++a)if(g=v[a].xy)if(c=v[a].vce,-1!=sa[ha].indexOf(c)){var k=g[0];c=g[1];g=g[3];if(!(k<f)&&e<parseFloat(c)+g){u=a;for(e=v[a].t;v[a]&&v[a].t==e;)G(v[a]),a+=1;break}}}}var f="",e="",b=0;u=0;wa={};fa=[];var g={},B,d,p=1E3,E=0;ha=0;if(c){var I=new Abc({imagesize:'width="100%"',img_out:function(a){-1!=a.indexOf("<svg")&&(fa[b]=
Object.keys(g),g={},b+=1,B<p&&(p=B),d>E&&(E=d));f+=a},errmsg:function(a,c,f){e+=a+"\n"},read_file:function(a){return""},anno_start:function(a,c,e,f,k,n,p){if("note"==a||"rest"==a)f=I.ax(f).toFixed(2),k=I.ay(k).toFixed(2),p=I.ah(p),wa[c]=[b,f,k,n,p];"bar"==a&&(k=I.ay(k),p=I.ah(p),k=Math.round(k+p),g[k]=1,d=I.ax(f),B=I.ax(0))},get_abcmodel:null});I.tosvg("abc2svg",c);""==e&&(e="no error");a(e.trim());f&&(w.innerHTML='<div id="leeg" style="height:'+xa+'px">&nbsp;</div>',w.innerHTML+=f,w.innerHTML+='<div id="leeg" style="height:'+
xa+'px">&nbsp;</div>',ia(document.getElementById("leeg"),"click",T),M=Array.prototype.slice.call(w.getElementsByTagName("svg")),c=Array.prototype.slice.call(w.getElementsByClassName("g")),ya=c.length?c:M,Ha(),M.forEach(function(a){cb&&(a.style.display="none");ia(a,"click",k)}),bb())}}function Ha(){if(0!=M.length){var a=M[0];var k=a.getBoundingClientRect().width;try{var f=a.viewBox.baseVal.width}catch(n){f=k}var e=(e=ya[0].transform)?e.baseVal:[];e=e.numberOfItems?e.getItem(0).matrix.a:1;ea=f/e/k}}
function Z(a){var c=void 0!=a;void 0==a&&(a=Oa);var f=Q.getBoundingClientRect().top,e=M[a].getBoundingClientRect().top,b=ha;f=Math.round(w.scrollTop+e+(fa[a][b]-Ma[b])/ea-30-f);f!=w.scrollTop&&(U&&(w.style["scroll-behavior"]=c?"smooth":"auto"),w.scrollTop=f);Oa=a}function Ia(a){function c(a){w.getBoundingClientRect();b.style.top=(e?a.touches[0].clientY:a.clientY)-15+"px";Z()}function f(a){b.removeEventListener("mousemove",c);b.removeEventListener("touchmove",c);b.removeEventListener("mouseup",f);
b.removeEventListener("touchend",f);b.removeEventListener("mouseleave",f);b.style.cursor="";b.classList.remove("spel")}a.preventDefault();var e="touchstart"==a.type,b=Q;b.style.cursor="row-resize";b.classList.add("spel");b.addEventListener("mousemove",c);b.addEventListener("touchmove",c);b.addEventListener("mouseup",f);b.addEventListener("touchend",f);b.addEventListener("mouseleave",f)}function G(a){var c,f;var e=ta[a.vce];if(c=a.xy){var b=c[0];var g=c[1];var d=c[2];var D=c[3];c=c[4];a.inv&&(c=D=
0);b!=ca[a.vce]&&((f=e.parentNode)&&f.removeChild(e),f=ya[b],f.insertBefore(e,f.firstChild),ca[a.vce]=b,Z(b));e.setAttribute("x",g);e.setAttribute("y",d);e.setAttribute("width",D);e.setAttribute("height",c)}else e.setAttribute("width",0),e.setAttribute("height",0)}function bb(){var a=0<u?v[u].t:0;v=[];za={};var b=1,f=0,e=0,d=0,g=0,B=0,D;for(D=0;D<O.length;++D){var p=O[D];if(p.bt&&0==p.v){if(p.t in za&&":"==p.bt[0])continue;if(1==b&&":"==p.bt[0]&&p.t>d){D=e-1;b=2;f+=p.t-d;continue}2==b&&":"==p.bt[0]&&
p.t>d&&(b=1);1==b&&":"==p.bt[p.bt.length-1]&&(e=D,d=p.t);g&&(p.tx||"|"!=p.bt)&&(g=0,f-=p.t-B);2==b&&"1"==p.tx&&(g=1,B=p.t)}g||(p.bt?za[p.t]=1:v.push({t:p.t+f,xy:wa[p.ix],ns:p.ns,vce:p.v,inv:p.inv,tmp:p.tmp}))}for(u=0;u<v.length&&(p=v[u],!(p.t>=a)||p.inv);++u);u==v.length&&--u;G(v[u])}function Y(){if(y){for(var a=1E3*y.currentTime,b=0,f;0==b;){var e=v[u];f=156.25/(e.tmp*L.value);u==v.length-1?(u=-1,b=e.ns[0].dur+1E3):(b=v[u+1].t,b=(b-e.t)*f);e.ns.forEach(function(c,b){f=192>=c.dur?1.3*f:1.1*f;b=c.mnum;
var g=c.dur*f,k=e.vce;c=c.velo;if(-1!=b){var d=b>>7;if(d in Aa&&F){var n=b%128;b=a/1E3;g=(g-1)/1E3;var m=Ba[d][n];if(m){var B=y.createBufferSource(),l=m.useflt,r=m.uselfo,t=m.useenv,v=J[k]/127;k=(K[k]-64)/64;B.buffer=m.buffer;m.loopStart&&(B.loop=!0,B.loopStart=m.loopStart,B.loopEnd=m.loopEnd);B.playbackRate.value=Ca[d][n];if(r){var w=y.createOscillator();w.frequency.value=m.lfofreq;d=y.createGain();d.gain.value=m.lfo2vol;w.connect(d);var h=y.createGain();h.gain.value=1;d.connect(h.gain);d=y.createGain();
d.gain.value=m.lfo2ptc;w.connect(d);d.connect(B.detune)}if(l){var x=y.createBiquadFilter();x.type="lowpass";x.frequency.value=m.filter}if(t){var q=1;d=y.createGain();d.gain.setValueAtTime(0,b);d.gain.linearRampToValueAtTime(q,b+m.envatt);n=m.envhld;var z=m.envdec;if(g>n){d.gain.setValueAtTime(q,b+n);if(g<z){var u=g-n;z=u/(z-n)*m.envsus}else u=z-n,z=m.envsus;q*=z;d.gain.linearRampToValueAtTime(q,b+n+u)}d.gain.setValueAtTime(q,b+g);n=b+g+q*m.envrel;d.gain.linearRampToValueAtTime(0,n);var A=y.createConstantSource();
A.offset.value=m.env2flt;A.connect(d);d.connect(x.detune)}if(V){var C=y.createStereoPanner();C.pan.value=k}q=c*v*m.atten*db;0==q&&(q=1E-5);c=y.createGain();c.gain.setValueAtTime(1E-5,b);c.gain.exponentialRampToValueAtTime(q,b+m.attack);n=m.hold;z=m.decay;g>n&&(c.gain.setValueAtTime(q,b+n),g<z?(u=g-n,z=Math.pow(10,u/(z-n)*Math.log10(m.sustain))):(u=z-n,z=m.sustain),q*=z,c.gain.exponentialRampToValueAtTime(q,b+n+u));c.gain.setValueAtTime(q,b+g);n=b+g+(100+20*Math.log10(q))/100*m.release;c.gain.exponentialRampToValueAtTime(1E-5,
n);l?(B.connect(x),x.connect(C||c)):B.connect(C||c);C&&C.connect(c);r?(c.connect(h),h.connect(y.destination)):c.connect(y.destination);B.start(b);r&&w.start(b+m.lfodel);t&&A.start(b);B.stop(n);r&&w.stop(n);t&&A.stop(n)}}else d in ja&&(h=[144,b,c],Pa(h,a,k),h[2]=0,Pa(h,a+g-1,k))}});G(e);u+=1}var d=a-Da;Da+=b;clearTimeout(Ea);Ea=setTimeout(Y,d<b?b-d:b)}else alert("Your browser has no Web Audio API -> no playback.")}function eb(a){switch(a.key){case "ArrowLeft":case "Left":--u;G(v[u]);break;case "ArrowRight":case "Right":u+=
1;G(v[u]);break;case "ArrowUp":case "Up":L.value=1*L.value+.1;break;case "ArrowDown":case "Down":L.value=1*L.value+-.1;break;case "m":$("#mbar").click();break;case "t":A.style.display="none"==A.style.display?"block":"none";break;case " ":a.preventDefault&&a.preventDefault(),T()}}function T(){v.length&&((Qa=1-Qa)?(ka.value="Stop",la.style.display="none",Da=1E3*y.currentTime,Y()):(ka.value="Play",clearTimeout(Ea)))}function Pa(a,b,f){if(0!=Ra){var c=a[0]&240,d=a[2];a=a[1];b/=1E3;128==c&&Sa(a,b);if(144==
c)if(0<d){c=J[f]/127;f=(K[f]-64)/64;var g=y.createBufferSource();g.buffer=Ta[a];var k=y.createGain();k.gain.setValueAtTime(1E-5,b);d=d*c*.015625;0==d&&(d=1E-5);k.gain.exponentialRampToValueAtTime(d,b+.001);if(V){var l=y.createStereoPanner();l.pan.value=f}g.connect(l||k);l&&l.connect(k);k.connect(y.destination);g.start(b);Fa[a]=[g,k,d]}else Sa(a,b)}}function Sa(a,b){var c=Fa[a],e=c[0],d=c[1];c=c[2];e&&(d.gain.setValueAtTime(c,b),d.gain.exponentialRampToValueAtTime(1E-5,b+.1),e.stop(b+.1),Fa[a]=void 0)}
function Ua(a){return new Promise(function(c,b){for(var e=atob(a),f=new ArrayBuffer(e.length),g=new Uint8Array(f),d=0;d<e.length;d++)g[d]=e.charCodeAt(d);y.decodeAudioData(f,function(a){c(a)},function(a){b("error dedoding audio sample")})})}function fb(a){return new Promise(function(c,b){function e(f){var g=instData[f];if(!g&&f<instData.length-1)e(f+1);else{var d={attack:g.attack,hold:g.hold,decay:g.decay,sustain:g.sustain,release:g.release,atten:g.atten,filter:g.filter,lfodel:g.lfodel,lfofreq:g.lfofreq,
lfo2ptc:g.lfo2ptc,lfo2vol:g.lfo2vol,envatt:g.envatt,envhld:g.envhld,envdec:g.envdec,envsus:g.envsus,envrel:g.envrel,env2flt:g.env2flt,uselfo:ma&&.008<g.lfofreq&&(0!=g.lfo2ptc||0!=g.lfo2vol),useflt:na&&16E3>g.filter,useenv:oa&&16E3>g.filter&&0!=g.env2flt};g.loopStart&&(d.loopStart=g.loopStart,d.loopEnd=g.loopEnd);var k=g.scale;var p=g.tune;for(var n=g.keyRangeLo;n<=g.keyRangeHi;n++)Ca[a][n]=Math.pow(Math.pow(2,1/12),(n+p)*k),Ba[a][n]=d;Ua(g.sample).then(function(a){d.buffer=a;f<instData.length-1?e(f+
1):(instData="",c("ok"))}).catch(function(a){b(a)})}}Ca[a]=[];Ba[a]=[];e(0)})}function Va(a,b){return new Promise(function(c,e){var f=document.createElement("script");f.src=b;f.onload=function(){c("ok");document.head.removeChild(f)};f.onerror=function(c){e("could not load instrument "+a)};document.head.appendChild(f)})}function da(){function c(a,f,e,d){var g=f[a];a==f.length?d():g in Aa?c(a+1,f,x.sf2url1,d):(l(a+" loading instrument: "+g+(e?" from: "+e:"")),Va(g,e+"instr"+g+"mp3.js").then(function(){return fb(g)}).then(function(){Aa[g]=
1;c(a+1,f,x.sf2url1,d)}).catch(function(g){b(g);e==x.sf2url1&&x.sf2url2?c(a,f,x.sf2url2,d):(b(" ... switch to MIDI-js"),F=0,da())}))}function d(a,c,f,e){var g=c[a],k=g in x.instTab?x.instTab[g]:gb[g];if(a==c.length)e();else if(ja[g])d(a+1,c,x.midijsUrl1,e);else{var n=f+k+"-mp3.js";l(a+" loading instrument: "+g+" from: "+n+"...");Va(g,n).then(function(){ja[g]=MIDI.Soundfont[k];d(a+1,c,x.midijsUrl1,e)}).catch(function(g){b(g);f==x.midijsUrl1?d(a,c,x.midijsUrl2,e):b(" ... give up")})}}function f(c,b){if(c==
b.length)Ra=1,A.style.display="none",a("notes decoded");else{var e=b[c],d=e>>7,g=e%128,k=ja[d]["C Db D Eb E F Gb G Ab A Bb B".split(" ")[g%12]+(Math.floor(g/12)-1)].split(",")[1];Ua(k).then(function(a){Ta[e]=a;A.innerHTML+=", "+d+":"+g;Wa[e]=1;f(c+1,b)})}}var e={};va.forEach(function(a){e[a>>7]=1});A.innerHTML=F?"Loading SF2 fonts<br>":"Loading MIDI-js fonts<br>";A.style.display="block";if(F)document.getElementById("sf2").checked="true",c(0,Object.keys(e),x.sf2url1,function(){A.style.display="none";
a("fonts geladen")});else{document.getElementById("midijs").checked="true";var n=va.filter(function(a){return!(a in Wa)});d(0,Object.keys(e),x.midijsUrl1,function(){a("fonts geladen");A.innerHTML+="decode notes:";f(0,n)})}}function hb(){var c="",b="",f,e={},d;H.innerHTML="";var g=window.location.href.replace("?dl=0","").split("?");if(1<g.length)for(g=g[1].split("&"),f=0;f<g.length;f++)if(e=g[f].replace(/d:(\w{15}\/[^.]+\.)/,"https://dl.dropboxusercontent.com/s/$1"),"noErr"==e)var l=1;else if("noMenu"==
e)var t=1;else if("noSave"==e)var p=1;else if("noErr"==e)l=1;else if("noDash"==e)var v=1;else"noRT"==e?F=0:"noPF"==e?Ja=1:"noLB"==e?Ka=1:(d=e.match(/noCur=([\da-fA-F]{2})/))?ua=parseInt(d[1],16):"nosm"==e?U=!1:"ios"==e?U=V=oa=na=ma=0:(d=e.match(/sf2=(\w+)/))?x.sf2url2=d[1]+"/":(d=e.match(/speed=([\d.]+)/))?x.speed=parseFloat(d[1]):b=e;if(g=document.getElementById("parms"))g.style.display="none";e=g?JSON.parse(g.innerHTML):{};void 0!=e.topSpace&&(xa=e.topSpace);void 0!=e.notationHeight&&(Xa=e.notationHeight);
void 0!=e.fileURL&&(b=e.fileURL);void 0!=e.gTempo&&(P=e.gTempo);void 0!=e.noCur&&(ua=e.noCur);if(void 0!=e.noDash&&e.noDash||v)Q.style.visibility="hidden";if(void 0!=e.noSave&&e.noSave||p)document.getElementById("savlbl").style.display="none";if(void 0!=e.noMenu&&e.noMenu||t)document.getElementById("mbar").style.display="none";if(void 0!=e.noErr&&e.noErr||l)H.style.display="none",H.style.height="0px";void 0!=e.instTab&&(x.instTab=e.instTab);void 0!=e.sf2url1&&(x.sf2url1=e.sf2url1);void 0!=e.sf2url2&&
(x.sf2url2=e.sf2url2);void 0!=e.midijsUrl1&&(x.midijsUrl1=e.midijsUrl1);void 0!=e.midijsUrl2&&(x.midijsUrl2=e.midijsUrl2);/(\.xml$)|(\.abc$)/.test(b)&&(c=b,b="");if(c){var u=document.getElementById("wait");u.style.display="block";var m=new XMLHttpRequest;m.open("GET",c,!0);m.onload=function(){a("preload ok");r(m.response);la.style.display="block";u.style.display="none"};m.onerror=function(){u.innerHTML+="\npreload failed"};m.send()}}function Ya(){var a=H.clientHeight;a=Math.round(100*a/document.documentElement.clientHeight);
w.style.height=Xa-a+"%"}function ib(){var c="",b="";if(ra&&((new Abc({imagesize:'width="100%"',img_out:function(a){c+=a},errmsg:function(a,c,f){b+=a+"\n"},read_file:null,anno_start:null,get_abcmodel:null})).tosvg("abc2svg",ra),""==b&&(b="no error"),a(b.trim()),c)){var f='<html><meta charset="utf-8"><div>\n'+c+"\n</div></html>\n";var e=qa+".html";try{var d=document.createElement("a");d.href="data:text/plain;charset=utf-8,"+encodeURIComponent(f);d.download=e;d.text="Save ABC file";document.getElementById("saveDiv").appendChild(d);
d.click()}catch(g){confirm("Do you want to save the ABC text?")&&(document.open("text/html"),document.write("<pre>"+f+"</pre>"),document.close())}}}function ia(a,b,f){function c(b){a.removeEventListener("mousedown",c);a.removeEventListener("touchend",c);console.log("event listeners removed from "+a.nodeName+"#"+a.id);y&&"suspended"==y.state&&y.resume().then(function(){console.log("resuming audioContext")})}a.addEventListener("mousedown",c);a.addEventListener("touchend",c);a.addEventListener(b,f)}
function Za(){function b(a){N.checked=!a;N.disabled=a;$a.style.color=a?"#aaa":"#000"}if("undefined"==typeof Dropbox){b(!0);var d=document.createElement("script");d.src="https://www.dropbox.com/static/api/2/dropins.js";d.onload=function(){b(!1);Dropbox.init({appKey:"ckknarypgq10318"});var a=Dropbox.createChooseButton({success:X,cancel:function(){},linkType:"direct",multiselect:!1,extensions:[".xml",".abc"]});ab.append(a);Za()};d.onerror=function(){a("loading dropbox API failed")};document.head.appendChild(d)}else document.querySelector(".dropbox-dropin-btn").style.display=
N.checked?"inline-block":"none",aa.style.display=N.checked?"none":"inline-block"}function jb(){var a=document.body,b=a.requestFullscreen||a.mozRequestFullScreen||a.webkitRequestFullscreen,f=document.exitFullscreen||document.mozCancelFullScreen||document.webkitExitFullscreen;b&&f&&($("#fscr").prop("checked")?b.call(a):f.call(document))}var x={speed:1,sf2url1:"./",sf2url2:"",instTab:{},midijsUrl1:"./",midijsUrl2:"https://rawgit.com/gleitz/midi-js-soundfonts/gh-pages/FluidR3_GM/"},ra,O,sa,Na,qa,u=0,
Qa=0,Ea,Ra=0,U,v=[],ba=[],za={},wa={},fa=[],M=[],ya=[],cb,xa=500,ea,ha=0,ca=[],Oa=0,ta=[],y=null,Ta=[],Fa=[],Wa={},va=[],Xa=100,pa=null,Ma=[],Aa={},ja=[],La={},J=[],K=[],w=null,A,H,ab,Q,aa,L,N,$a,Ga,W,la,ka,gb="acoustic_grand_piano bright_acoustic_piano electric_grand_piano honkytonk_piano electric_piano_1 electric_piano_2 harpsichord clavinet celesta glockenspiel music_box vibraphone marimba xylophone tubular_bells dulcimer drawbar_organ percussive_organ rock_organ church_organ reed_organ accordion harmonica tango_accordion acoustic_guitar_nylon acoustic_guitar_steel electric_guitar_jazz electric_guitar_clean electric_guitar_muted overdriven_guitar distortion_guitar guitar_harmonics acoustic_bass electric_bass_finger electric_bass_pick fretless_bass slap_bass_1 slap_bass_2 synth_bass_1 synth_bass_2 violin viola cello contrabass tremolo_strings pizzicato_strings orchestral_harp timpani string_ensemble_1 string_ensemble_2 synth_strings_1 synth_strings_2 choir_aahs voice_oohs synth_choir orchestra_hit trumpet trombone tuba muted_trumpet french_horn brass_section synth_brass_1 synth_brass_2 soprano_sax alto_sax tenor_sax baritone_sax oboe english_horn bassoon clarinet piccolo flute recorder pan_flute blown_bottle shakuhachi whistle ocarina lead_1_square lead_2_sawtooth lead_3_calliope lead_4_chiff lead_5_charang lead_6_voice lead_7_fifths lead_8_bass__lead pad_1_new_age pad_2_warm pad_3_polysynth pad_4_choir pad_5_bowed pad_6_metallic pad_7_halo pad_8_sweep fx_1_rain fx_2_soundtrack fx_3_crystal fx_4_atmosphere fx_5_brightness fx_6_goblins fx_7_echoes fx_8_scifi sitar banjo shamisen koto kalimba bagpipe fiddle shanai tinkle_bell agogo steel_drums woodblock taiko_drum melodic_tom synth_drum reverse_cymbal guitar_fret_noise breath_noise seashore bird_tweet telephone_ring helicopter applause gunshot".split(" "),
P=120,Ba=[],Ca=[],F=1,Ja=0,Ka=0,ua=0,db=.5/60,V=1,ma=1,na=1,oa=1,Da;document.addEventListener("DOMContentLoaded",function(){A=document.getElementById("comp");w=document.getElementById("notation");H=document.getElementById("err");Q=document.getElementById("rollijn");ab=document.getElementById("abcfile");aa=document.getElementById("fknp");L=document.getElementById("tempo");la=document.getElementById("playbk");ka=document.getElementById("play");ia(ka,"click",T);ia(la,"click",T);aa.addEventListener("change",
d);document.getElementById("save").addEventListener("click",ib);Q.addEventListener("mousedown",Ia);Q.addEventListener("touchstart",Ia);window.addEventListener("resize",function(){Ha();Ya();Z()});w.addEventListener("drop",t);w.addEventListener("dragover",function(a){a.stopPropagation();a.preventDefault();a.dataTransfer.dropEffect="copy"});w.addEventListener("dragenter",function(){this.classList.add("indrag")});w.addEventListener("dragleave",function(){this.classList.remove("indrag")});N=document.getElementById("drpuse");
N.checked=!1;N.addEventListener("click",Za);$a=document.getElementById("drplbl");Ga=document.getElementById("mbar");W=document.getElementById("menu");W.style.display="none";Ga.addEventListener("click",function(a){a.stopPropagation();a="none"==W.style.display;W.style.display=a?"block":"none";Ga.style.background=a?"#aaa":""});W.addEventListener("click",function(a){a.stopPropagation()});U=CSS.supports("scroll-behavior","smooth");hb();Ya();var a=window.AudioContext||window.webkitAudioContext;y=void 0!=
a?new a:null;a=["Your browser does not support:"];var b=0;U||a.push("* smooth scrolling");y?(y.createStereoPanner||(V=0),y.createOscillator||(ma=0),y.createBiquadFilter||(na=0),y.createConstantSource||(oa=0),V||a.push("* the StereoPanner element"),F&&!ma&&(a.push("* the Oscillator element"),b=1),F&&!na&&(a.push("* the BiquadFilter element"),b=1),F&&!oa&&(a.push("* the ConstantSource element"),b=1),b&&(a.push("You are probably on iOS, which does not support the Web Audio API."),a.push("Real time synthesis is switched off, falling back to MIDIjs"),
F=0,document.getElementById("midijs").checked="true")):a.push("* the Web Audio API -> no sound");1<a.length&&alert(a.join("\n"));document.getElementById("verlab").innerHTML="<span>Version:</span>"+xmlplay_VERSION;$("#fscr").on("change",jb);$("body").on("fullscreenchange webkitfullscreenchange mozfullscreenchange",function(){var a=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement;$("#fscr").prop("checked",null!=a)});document.body.addEventListener("keydown",
eb);document.getElementById("midijs").addEventListener("click",function(a){F=0;da()});document.getElementById("sf2").addEventListener("click",function(a){F=1;da()})})})();
